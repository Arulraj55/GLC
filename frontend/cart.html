<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Cart - GreenLink</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-shop: #1565c0;
      --primary-shop-dark: #0d47a1;
      --primary-customer: #2e7d32;
      --primary-customer-dark: #1b5e20;
      --accent: #ff9800;
      --danger: #d32f2f;
      --bg: #f5f7fa;
      --surface: #ffffff;
      --text: #1a2433;
      --muted: #5d6b7a;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      min-height: 100vh;
      padding-bottom: 100px;
    }
    body.shop-mode { --primary: var(--primary-shop); --primary-dark: var(--primary-shop-dark); }
    body.customer-mode { --primary: var(--primary-customer); --primary-dark: var(--primary-customer-dark); }
    body.guest-mode { --primary: #757575; --primary-dark: #424242; }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary, #1565c0), var(--primary-dark, #0d47a1));
      color: #fff;
      padding: 20px 30px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .back-btn {
      width: 45px;
      height: 45px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .back-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateX(-3px);
    }
    .header-title h1 {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-title p {
      font-size: 14px;
      opacity: 0.85;
      margin-top: 4px;
    }
    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }
    .user-badge i {
      font-size: 16px;
    }
    
    /* Main Content */
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* Stats Bar */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .stat-icon.items { background: #e3f2fd; color: #1565c0; }
    .stat-icon.total { background: #e8f5e9; color: #2e7d32; }
    .stat-icon.savings { background: #fff3e0; color: #f57c00; }
    .stat-info h3 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
    }
    .stat-info p {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    /* Cart Grid */
    .cart-section-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .cart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
    }
    
    .cart-card {
      background: var(--surface);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      transition: all 0.3s;
      position: relative;
    }
    .cart-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    }
    .cart-card .card-image {
      height: 160px;
      background-size: cover;
      background-position: center;
      background-color: #e8f5e9;
      position: relative;
    }
    .cart-card .card-image::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.4) 0%, transparent 50%);
    }
    .cart-card .price-tag {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: var(--accent);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 16px;
      z-index: 5;
    }
    .cart-card .card-body {
      padding: 20px;
    }
    .cart-card h3 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }
    .cart-card .source {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 16px;
    }
    .cart-card .source i {
      color: var(--primary, #1565c0);
    }
    .cart-card .card-actions {
      display: flex;
      gap: 12px;
    }
    .cart-card .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .cart-card .btn.remove {
      background: #ffebee;
      color: var(--danger);
    }
    .cart-card .btn.remove:hover {
      background: var(--danger);
      color: #fff;
    }
    .cart-card .btn.checkout {
      background: var(--primary, #1565c0);
      color: #fff;
    }
    .cart-card .btn.checkout:hover {
      background: var(--primary-dark, #0d47a1);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      background: var(--surface);
      border-radius: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }
    .empty-state .icon {
      width: 120px;
      height: 120px;
      background: #f5f5f5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 30px;
      font-size: 50px;
    }
    .empty-state h2 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 12px;
    }
    .empty-state p {
      font-size: 16px;
      color: var(--muted);
      margin-bottom: 30px;
    }
    .empty-state .shop-btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 16px 32px;
      background: var(--primary, #1565c0);
      color: #fff;
      border-radius: 30px;
      font-weight: 600;
      font-size: 16px;
      text-decoration: none;
      transition: all 0.3s;
    }
    .empty-state .shop-btn:hover {
      background: var(--primary-dark, #0d47a1);
      transform: scale(1.05);
    }
    
    /* Checkout Bar */
    .checkout-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      padding: 20px 30px;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      z-index: 100;
    }
    .checkout-bar .bar-content {
      max-width: 1200px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .checkout-bar .total-info h3 {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .checkout-bar .total-info .amount {
      font-size: 28px;
      font-weight: 800;
      color: var(--primary, #1565c0);
    }
    .checkout-bar .checkout-btn {
      padding: 16px 40px;
      background: var(--primary, #1565c0);
      color: #fff;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .checkout-bar .checkout-btn:hover {
      background: var(--primary-dark, #0d47a1);
      transform: scale(1.03);
    }
    .checkout-bar .checkout-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Loading State */
    .loading {
      text-align: center;
      padding: 60px;
      color: var(--muted);
      font-size: 18px;
    }
    .loading i {
      font-size: 40px;
      margin-bottom: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 800px) {
      .stats-bar { grid-template-columns: 1fr; }
      .header-content { flex-direction: column; gap: 15px; text-align: center; }
      .header-left { flex-direction: column; }
      .checkout-bar .bar-content { flex-direction: column; gap: 15px; text-align: center; }
    }
  </style>
</head>
<body class="guest-mode">
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <div class="header-title">
          <h1><i class="fas fa-shopping-cart"></i> My Cart</h1>
          <p id="userInfo">Loading your cart...</p>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:15px;">
        <a href="my_orders.html" style="color:#fff;text-decoration:none;padding:8px 16px;background:rgba(255,255,255,0.15);border-radius:10px;font-weight:600;display:flex;align-items:center;gap:8px;transition:0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'"><i class="fas fa-box"></i> My Orders</a>
        <div class="user-badge" id="userBadge">
          <i class="fas fa-user"></i>
          <span>Guest</span>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <!-- Stats -->
    <div class="stats-bar" id="statsBar" style="display:none;">
      <div class="stat-card">
        <div class="stat-icon items"><i class="fas fa-box"></i></div>
        <div class="stat-info">
          <h3 id="statItems">0</h3>
          <p>Items in Cart</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon total"><i class="fas fa-rupee-sign"></i></div>
        <div class="stat-info">
          <h3 id="statTotal">‚Çπ0</h3>
          <p>Total Amount</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon savings"><i class="fas fa-tags"></i></div>
        <div class="stat-info">
          <h3 id="statAvg">‚Çπ0</h3>
          <p>Average per Item</p>
        </div>
      </div>
    </div>

    <!-- Cart Items -->
    <div id="cartContainer">
      <div class="loading">
        <i class="fas fa-spinner"></i>
        <p>Loading your cart...</p>
      </div>
    </div>
  </main>

  <!-- Checkout Bar -->
  <div class="checkout-bar" id="checkoutBar" style="display:none;">
    <div class="bar-content">
      <div class="total-info">
        <h3>Total Amount</h3>
        <div class="amount" id="totalAmount">‚Çπ0</div>
      </div>
      <button class="checkout-btn" id="checkoutBtn" onclick="proceedToCheckout()">
        <i class="fas fa-lock"></i> Proceed to Checkout
      </button>
    </div>
  </div>

  <script>
    let userSession = null;
    let cartItems = [];

    async function init() {
      // Get session info
      try {
        const res = await fetch('/api/session', { credentials: 'include' });
        userSession = await res.json();
        console.log('Session:', userSession);
        updateUIForUser();
      } catch (e) {
        console.error('Session check failed:', e);
        userSession = { loggedIn: false };
        updateUIForUser();
      }
      
      await loadCart();
    }

    function updateUIForUser() {
      const body = document.body;
      const badge = document.getElementById('userBadge');
      const info = document.getElementById('userInfo');
      
      body.classList.remove('shop-mode', 'customer-mode', 'guest-mode');
      
      if (userSession?.loggedIn) {
        if (userSession.role === 'shop') {
          body.classList.add('shop-mode');
          badge.innerHTML = '<i class="fas fa-store"></i><span>Shop Owner</span>';
          info.textContent = `${userSession.username}'s Shop Cart`;
        } else if (userSession.role === 'customer') {
          body.classList.add('customer-mode');
          badge.innerHTML = '<i class="fas fa-user"></i><span>Customer</span>';
          info.textContent = `${userSession.username}'s Cart`;
        } else if (userSession.role === 'farmer') {
          body.classList.add('customer-mode');
          badge.innerHTML = '<i class="fas fa-seedling"></i><span>Farmer</span>';
          info.textContent = `${userSession.username}'s Cart`;
        }
      } else {
        body.classList.add('guest-mode');
        badge.innerHTML = '<i class="fas fa-user-slash"></i><span>Guest</span>';
        info.textContent = 'Please sign in to view your cart';
      }
    }

    async function loadCart() {
      const container = document.getElementById('cartContainer');
      
      try {
        const res = await fetch('/api/cart', { credentials: 'include' });
        cartItems = await res.json();
        console.log('Cart items:', cartItems);
        renderCart();
      } catch (e) {
        console.error('Load cart error:', e);
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">‚ùå</div>
            <h2>Error Loading Cart</h2>
            <p>Something went wrong. Please try again later.</p>
          </div>
        `;
      }
    }

    function renderCart() {
      const container = document.getElementById('cartContainer');
      const statsBar = document.getElementById('statsBar');
      const checkoutBar = document.getElementById('checkoutBar');
      
      if (!cartItems || cartItems.length === 0) {
        statsBar.style.display = 'none';
        checkoutBar.style.display = 'none';
        
        const shopLink = userSession?.role === 'shop' ? 'buy.html' : 'index1.html';
        const shopText = userSession?.role === 'shop' ? 'Browse Farmers' : 'Start Shopping';
        
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üõí</div>
            <h2>Your Cart is Empty</h2>
            <p>Looks like you haven't added any products yet. Start shopping to fill your cart!</p>
            <a href="${shopLink}" class="shop-btn"><i class="fas fa-shopping-bag"></i> ${shopText}</a>
          </div>
        `;
        return;
      }
      
      // Calculate stats
      const total = cartItems.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
      const avg = total / cartItems.length;
      
      // Update stats
      document.getElementById('statItems').textContent = cartItems.length;
      document.getElementById('statTotal').textContent = `‚Çπ${total.toFixed(0)}`;
      document.getElementById('statAvg').textContent = `‚Çπ${avg.toFixed(0)}`;
      document.getElementById('totalAmount').textContent = `‚Çπ${total.toFixed(0)}`;
      
      statsBar.style.display = 'grid';
      checkoutBar.style.display = 'flex';
      
      // Extended product image mapping for fallback
      const productImageMapping = {
        'Carrot': 'product1.jpg',
        'Carrots': 'product1.jpg',
        'Tomato': 'product2.jpg',
        'Tomatoes': 'product2.jpg',
        'Potato': 'product3.jpg',
        'Potatoes': 'product3.jpg',
        'Corn': 'product4.jpg',
        'Cucumber': 'product5.jpg',
        'Onion': 'product6.jpg',
        'Onions': 'product6.jpg',
        'Garlic': 'product7.jpg',
        'Lettuce': 'product8.jpg',
        'Bell Pepper': 'product9.jpg',
        'Broccoli': 'product10.jpg',
        'Eggplant': 'product11.jpg',
        'Brinjal': 'product11.jpg',
        'Green Pepper': 'product12.jpg',
        'Green Chilies': 'product12.jpg',
        'Spinach': 'product13.jpg',
        'Greens': 'product13.jpg',
        'Beetroot': 'product14.jpg',
        'Coriander': 'product15.jpg',
        'Coriander Leaves': 'product15.jpg',
        'Cabbage': 'product16.jpg',
        'Ginger': 'product7.jpg',
        'Mushroom': 'product10.jpg',
        'Bitterguards': 'product11.jpg',
        'Bitter Guard': 'product11.jpg',
        'Bananas': 'product4.jpg',
        'Lemons': 'product5.jpg',
        'Water Melons': 'product4.jpg',
        'Watermelons': 'product4.jpg',
        'Raddish': 'product1.jpg',
        'Pumpkin': 'product16.jpg',
        'Drum Stick': 'product5.jpg',
        'Drum Sticks': 'product5.jpg',
        'Scarlet Gourds': 'product11.jpg',
        'Wheat': 'product4.jpg',
        'Peas': 'product5.jpg',
        'Sweet Potato': 'product3.jpg',
        'Cauli Flower': 'product10.jpg',
        'Cauli Flowers': 'product10.jpg',
        "Lady's Finger": 'product5.jpg',
      };
      
      // Render cards
      let html = '<h2 class="cart-section-title"><i class="fas fa-box"></i> Your Items</h2><div class="cart-grid">';
      
      cartItems.forEach(item => {
        // Get image - remove 'frontend/' prefix, use mapping as fallback
        let imgSrc = item.image || '';
        imgSrc = imgSrc.replace('frontend/', '');
        
        // If image is empty or default, try to map from product name
        if (!imgSrc || imgSrc === 'default.jpg' || imgSrc === '') {
          imgSrc = productImageMapping[item.product] || 'product1.jpg';
        }
        
        // Handle images folder path (keep as-is if it starts with 'images/')
        // Otherwise assume it's in root frontend folder
        if (!imgSrc.startsWith('images/') && !imgSrc.startsWith('uploads/')) {
          // It's a product*.jpg file in the frontend folder
          imgSrc = imgSrc;
        }
        
        const price = parseFloat(item.price) || 0;
        const source = item.farmer || item.shop || 'Unknown';
        
        html += `
          <div class="cart-card">
            <div class="card-image" style="background-image: url('${imgSrc}')" onerror="this.style.backgroundImage='url(product1.jpg)'">
              <div class="price-tag">‚Çπ${price}</div>
            </div>
            <div class="card-body">
              <h3>${item.product || 'Product'}</h3>
              <div class="source">
                <i class="fas fa-store"></i>
                <span>From: ${source}</span>
              </div>
              <div class="card-actions">
                <button class="btn remove" onclick="removeFromCart('${item._id}')">
                  <i class="fas fa-trash"></i> Remove
                </button>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    async function removeFromCart(id) {
      if (!confirm('Remove this item from cart?')) return;
      
      try {
        await fetch(`/api/cart/${id}`, { 
          method: 'DELETE',
          credentials: 'include'
        });
        await loadCart();
      } catch (e) {
        console.error('Remove error:', e);
        alert('Failed to remove item');
      }
    }

    function proceedToCheckout() {
      if (cartItems.length === 0) {
        alert('Your cart is empty!');
        return;
      }
      // Redirect to checkout page
      window.location.href = 'checkout.html';
    }

    function goBack() {
      if (userSession?.role === 'shop') {
        window.location.href = 'login1.html';
      } else if (userSession?.role === 'customer') {
        window.location.href = 'index1.html';
      } else {
        window.location.href = 'index.html';
      }
    }

    // Initialize
    init();
  </script>
</body>
</html>
